name: Swarm Discovery

on:
  issues:
    types: [labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number to resume"
        required: true
        type: number
      dry_run:
        description: "Run without calling Claude (test shell logic only)"
        required: false
        type: boolean
        default: false

concurrency:
  group: swarm-issue-${{ github.event.inputs.issue_number || github.event.issue.number }}
  cancel-in-progress: false

jobs:
  discovery:
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event.label.name == 'ready-to-build')
    permissions:
      contents: write        # git push
      issues: write          # gh issue edit (labels, comments)
      pull-requests: write   # gh pr create --draft
      id-token: write        # claude-code-action OIDC token
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Fetch main branch history
        run: git fetch origin main --depth=50

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Resolve issue number
        id: issue
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ github.event.inputs.issue_number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ github.event.issue.number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create branch and initialize state
        run: |
          ISSUE=${{ steps.issue.outputs.number }}
          BRANCH="swarm/issue-${ISSUE}"

          # Create or checkout branch
          if git ls-remote --heads origin "$BRANCH" | grep -q "$BRANCH"; then
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git pull origin "$BRANCH" --rebase
          else
            git checkout -b "$BRANCH"
          fi

          # Initialize swarm-state.json if idle
          STATUS=$(jq -r '.status' swarm-state.json)
          if [ "$STATUS" = "idle" ]; then
            jq --argjson issue "$ISSUE" \
              '.current_issue = $issue | .status = "active" | .current_stage = "discovery" | .last_updated = now | .human_input_needed = false' \
              swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          fi

          mkdir -p .swarm/logs

      - name: Update labels
        if: github.event_name != 'workflow_dispatch'
        run: |
          ISSUE=${{ steps.issue.outputs.number }}
          gh issue edit "$ISSUE" --remove-label "ready-to-build" --add-label "swarm-working" || true

      # --- Check if human input needed before starting ---
      - name: Check human gate
        id: gate
        run: |
          if [ "$(jq -r '.human_input_needed' swarm-state.json)" = "true" ]; then
            echo "blocked=true" >> "$GITHUB_OUTPUT"
            echo "Human input needed — exiting."
            git add -A
            git diff --cached --quiet || { git commit -m "swarm: awaiting human input"; git push origin HEAD; }
          else
            echo "blocked=false" >> "$GITHUB_OUTPUT"
          fi

      # --- Read resume state ---
      - name: Read resume state
        if: steps.gate.outputs.blocked != 'true'
        id: state
        run: |
          LAST_AGENT=$(jq -r '.last_agent // ""' swarm-state.json)
          RESUME_AGENT=$(jq -r '.resume_agent // ""' swarm-state.json)
          echo "last_agent=$LAST_AGENT" >> "$GITHUB_OUTPUT"
          echo "resume_agent=$RESUME_AGENT" >> "$GITHUB_OUTPUT"

      # =============================================
      # Triage — classify issue tier
      # =============================================

      - name: Triage issue
        if: steps.gate.outputs.blocked != 'true'
        id: triage
        run: |
          ISSUE=${{ steps.issue.outputs.number }}

          # Check if tier is already set in state (resume case)
          EXISTING_TIER=$(jq -r '.issue_tier // ""' swarm-state.json)
          if [ -n "$EXISTING_TIER" ] && [ "$EXISTING_TIER" != "null" ]; then
            echo "tier=$EXISTING_TIER" >> "$GITHUB_OUTPUT"
            echo "Resuming with existing tier: $EXISTING_TIER"
            exit 0
          fi

          # Fetch issue metadata
          TITLE=$(gh issue view "$ISSUE" --json title -q '.title')
          LABELS=$(gh issue view "$ISSUE" --json labels -q '.labels[].name')

          # Manual labels take precedence
          if echo "$LABELS" | grep -q "swarm-tier:bugfix"; then TIER="bugfix"
          elif echo "$LABELS" | grep -q "swarm-tier:enhancement"; then TIER="enhancement"
          elif echo "$LABELS" | grep -q "swarm-tier:feature"; then TIER="feature"
          # Auto-detect from template prefix
          elif echo "$TITLE" | grep -qi "^\[Bug\]:"; then TIER="bugfix"
          elif echo "$TITLE" | grep -qi "^\[Feature\]:"; then TIER="feature"
          # Unknown → full pipeline
          else TIER="feature"
          fi

          echo "tier=$TIER" >> "$GITHUB_OUTPUT"
          echo "Triaged as: $TIER"

          # Write tier to state
          jq --arg tier "$TIER" '.issue_tier = $tier' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json

          # Apply tier label to the issue
          gh issue edit "$ISSUE" --add-label "swarm-tier:${TIER}" || true

      # =============================================
      # Agent 1: Business Analyst
      # =============================================

      - name: Check if business-analyst should run
        if: steps.gate.outputs.blocked != 'true'
        id: ba_check
        run: |
          LAST="${{ steps.state.outputs.last_agent }}"
          RESUME="${{ steps.state.outputs.resume_agent }}"
          # Run if: no last agent (fresh start), or resume_agent is business-analyst
          if [ -z "$LAST" ] || [ "$LAST" = "null" ] || [ "$RESUME" = "business-analyst" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Business Analyst
        if: steps.gate.outputs.blocked != 'true' && steps.ba_check.outputs.run == 'true' && inputs.dry_run != true
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Business Analyst agent. Read and follow ALL instructions in .swarm/prompts/business-analyst.md.
            Issue number: ${{ steps.issue.outputs.number }}
            Issue tier: ${{ steps.triage.outputs.tier }}
            Repository: ${{ github.repository }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: false

      - name: "Run Business Analyst [dry-run]"
        if: steps.gate.outputs.blocked != 'true' && steps.ba_check.outputs.run == 'true' && inputs.dry_run == true
        run: |
          echo "[DRY-RUN] Business Analyst would run here"
          mkdir -p docs
          echo "# Mock business brief" > docs/business-brief.md
          jq '.last_agent = "business-analyst" | .human_input_needed = false' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json

      - name: Post-BA state update
        if: steps.gate.outputs.blocked != 'true' && steps.ba_check.outputs.run == 'true'
        run: |
          BRANCH=$(git branch --show-current)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add -A
          git diff --cached --quiet || git commit -m "swarm: business-analyst artifacts"
          git pull origin "$BRANCH" --rebase || true
          jq '.last_agent = "business-analyst" | .resume_agent = null | .last_updated = (now | tostring)' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: business-analyst complete"; git push origin HEAD; }

      - name: Check human gate after BA
        if: steps.gate.outputs.blocked != 'true' && steps.ba_check.outputs.run == 'true'
        id: gate_ba
        run: |
          if [ "$(jq -r '.human_input_needed' swarm-state.json)" = "true" ]; then
            echo "blocked=true" >> "$GITHUB_OUTPUT"
          else
            echo "blocked=false" >> "$GITHUB_OUTPUT"
          fi

      # =============================================
      # Agent 2: Product Strategist
      # =============================================

      - name: Check if product-strategist should run
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true'
        id: ps_check
        run: |
          TIER="${{ steps.triage.outputs.tier }}"
          LAST="${{ steps.state.outputs.last_agent }}"
          RESUME="${{ steps.state.outputs.resume_agent }}"
          BA_RAN="${{ steps.ba_check.outputs.run }}"
          # PS only runs for feature tier
          if [ "$TIER" != "feature" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
          elif [ "$BA_RAN" = "true" ] || [ "$RESUME" = "product-strategist" ] || [ "$LAST" = "business-analyst" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Product Strategist
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.ps_check.outputs.run == 'true' &&
          inputs.dry_run != true
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Product Strategist agent. Read and follow ALL instructions in .swarm/prompts/product-strategist.md.
            Issue number: ${{ steps.issue.outputs.number }}
            Repository: ${{ github.repository }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: false

      - name: "Run Product Strategist [dry-run]"
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.ps_check.outputs.run == 'true' &&
          inputs.dry_run == true
        run: |
          echo "[DRY-RUN] Product Strategist would run here"
          mkdir -p docs
          echo "# Mock product spec" > docs/product-spec.md
          jq '.last_agent = "product-strategist" | .human_input_needed = false' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json

      - name: Post-PS state update
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.ps_check.outputs.run == 'true'
        run: |
          BRANCH=$(git branch --show-current)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add -A
          git diff --cached --quiet || git commit -m "swarm: product-strategist artifacts"
          git pull origin "$BRANCH" --rebase || true
          jq '.last_agent = "product-strategist" | .resume_agent = null | .last_updated = (now | tostring)' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: product-strategist complete"; git push origin HEAD; }

      - name: Check human gate after PS
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.ps_check.outputs.run == 'true'
        id: gate_ps
        run: |
          if [ "$(jq -r '.human_input_needed' swarm-state.json)" = "true" ]; then
            echo "blocked=true" >> "$GITHUB_OUTPUT"
          else
            echo "blocked=false" >> "$GITHUB_OUTPUT"
          fi

      # =============================================
      # Agent 3: Architect
      # =============================================

      - name: Check if architect should run
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true'
        id: arch_check
        run: |
          TIER="${{ steps.triage.outputs.tier }}"
          LAST="${{ steps.state.outputs.last_agent }}"
          RESUME="${{ steps.state.outputs.resume_agent }}"
          PS_RAN="${{ steps.ps_check.outputs.run }}"
          BA_RAN="${{ steps.ba_check.outputs.run }}"
          # Architect skipped for bugfix tier
          if [ "$TIER" = "bugfix" ]; then
            echo "run=false" >> "$GITHUB_OUTPUT"
          # For enhancement tier, architect runs after BA (PS is skipped)
          elif [ "$TIER" = "enhancement" ] && { [ "$BA_RAN" = "true" ] || [ "$LAST" = "business-analyst" ]; }; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          # Standard: architect runs after PS or on resume
          elif [ "$PS_RAN" = "true" ] || [ "$RESUME" = "architect" ] || [ "$LAST" = "product-strategist" ]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run Architect
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.arch_check.outputs.run == 'true' &&
          inputs.dry_run != true
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Architect agent. Read and follow ALL instructions in .swarm/prompts/architect.md.
            Issue number: ${{ steps.issue.outputs.number }}
            Repository: ${{ github.repository }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: false

      - name: "Run Architect [dry-run]"
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.arch_check.outputs.run == 'true' &&
          inputs.dry_run == true
        run: |
          echo "[DRY-RUN] Architect would run here"
          mkdir -p docs
          echo "# Mock architecture spec" > docs/architecture-spec.md
          jq '.last_agent = "architect" | .human_input_needed = false' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json

      - name: Post-Architect state update
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.arch_check.outputs.run == 'true'
        run: |
          BRANCH=$(git branch --show-current)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add -A
          git diff --cached --quiet || git commit -m "swarm: architect artifacts"
          git pull origin "$BRANCH" --rebase || true
          jq '.last_agent = "architect" | .resume_agent = null | .last_updated = (now | tostring)' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: architect complete"; git push origin HEAD; }

      - name: Check human gate after Architect
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.arch_check.outputs.run == 'true'
        id: gate_arch
        run: |
          if [ "$(jq -r '.human_input_needed' swarm-state.json)" = "true" ]; then
            echo "blocked=true" >> "$GITHUB_OUTPUT"
          else
            echo "blocked=false" >> "$GITHUB_OUTPUT"
          fi

      # =============================================
      # Agent 4: Tech Lead (Planning)
      # =============================================

      - name: Update stage to planning
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true'
        run: |
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          jq '.current_stage = "planning"' swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: discovery complete, starting planning"; git push origin HEAD; }

      - name: Run Tech Lead
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true' &&
          inputs.dry_run != true
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are the Tech Lead agent. Read and follow ALL instructions in .swarm/prompts/tech-lead.md.
            Issue number: ${{ steps.issue.outputs.number }}
            Issue tier: ${{ steps.triage.outputs.tier }}
            Repository: ${{ github.repository }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: false

      - name: "Run Tech Lead [dry-run]"
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true' &&
          inputs.dry_run == true
        run: |
          echo "[DRY-RUN] Tech Lead would run here"
          mkdir -p docs
          echo "# Mock implementation plan" > docs/plan.md
          jq '.last_agent = "tech-lead" | .human_input_needed = false | .total_tasks = 3 | .tasks = [{"title":"Mock task 1"},{"title":"Mock task 2"},{"title":"Mock task 3"}]' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json

      - name: Post-TL state update and commit
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true'
        run: |
          BRANCH=$(git branch --show-current)
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          git add -A
          git diff --cached --quiet || git commit -m "swarm: tech-lead artifacts"
          git pull origin "$BRANCH" --rebase || true
          jq '.last_agent = "tech-lead" | .resume_agent = null | .last_updated = (now | tostring)' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: implementation plan ready"; git push origin HEAD; }

      # --- Open draft PR ---
      - name: Open draft PR
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/github-integration.sh
          source scripts/github-integration.sh
          gh_open_draft_pr

      - name: Mark awaiting plan approval
        if: >
          steps.gate.outputs.blocked != 'true' &&
          steps.gate_ba.outputs.blocked != 'true' &&
          steps.gate_ps.outputs.blocked != 'true' &&
          steps.gate_arch.outputs.blocked != 'true'
        run: |
          git remote set-url origin "https://x-access-token:${GH_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
          jq '.human_input_needed = true | .human_input_channel = "pr" | .current_stage = "planning"' \
            swarm-state.json > tmp.json && mv tmp.json swarm-state.json
          git add -A
          git diff --cached --quiet || { git commit -m "swarm: awaiting plan approval on PR"; git push origin HEAD; }

      # --- Failure / Artifacts ---
      - name: Notify issue on failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        run: |
          ISSUE="${{ steps.issue.outputs.number }}"
          if [ -n "$ISSUE" ] && [ "$ISSUE" != "null" ]; then
            LAST_AGENT=$(jq -r '.last_agent // "unknown"' swarm-state.json 2>/dev/null || echo "unknown")
            STAGE=$(jq -r '.current_stage // "unknown"' swarm-state.json 2>/dev/null || echo "unknown")
            printf '## Discovery Failed\n**Stage**: %s | **Last agent**: %s\n**Run**: %s\n\nCheck the workflow logs for details.' \
              "$STAGE" "$LAST_AGENT" "$RUN_URL" | gh issue comment "$ISSUE" --body-file -
          fi

      - name: Upload swarm logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swarm-logs-${{ github.run_id }}
          path: .swarm/logs/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload state snapshot
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: swarm-state-${{ github.run_id }}
          path: swarm-state.json
          retention-days: 30
